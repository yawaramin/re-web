<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Response (re-web.ReWeb.Response)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.0.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../index.html">re-web</a> &#x00BB; <a href="../index.html">ReWeb</a> &#x00BB; Response</nav><header class="odoc-preamble"><h1>Module <code><span>ReWeb.Response</span></code></h1><p>Send responses.</p><p>For the response functions below, <code>status</code> defaults to <code>`OK</code> unless otherwise noted, and the <code>cookies</code> parameter is converted into response headers and merged with the <code>headers</code> parameter. There is therefore a chance of duplication which you will have to watch out for.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec module" id="module-Header" class="anchored"><a href="#module-Header" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Header/index.html">Header</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-headers" class="anchored"><a href="#type-headers" class="anchor"></a><code><span><span class="keyword">type</span> headers</span><span> = <span><span>(string * string)</span> list</span></span></code></div><div class="spec-doc"><p>a header <code>X-Client-Id: 1</code> is represented as: <code>[(&quot;x-client-id&quot;, &quot;1&quot;)]</code>.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-status" class="anchored"><a href="#type-status" class="anchor"></a><code><span><span class="keyword">type</span> status</span><span> = <span class="xref-unresolved">Httpaf</span>.Status.t</span></code></div><div class="spec-doc"><p>See <a href="https://b0-system.github.io/odig/doc@odoc.default/httpaf/Httpaf/Status/index.html">Httpaf.Status</a> for valid statuses.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-http" class="anchored"><a href="#type-http" class="anchor"></a><code><span><span class="keyword">type</span> http</span><span> = </span><span>[ </span></code><table><tr id="type-http.HTTP" class="anchored"><td class="def constructor"><a href="#type-http.HTTP" class="anchor"></a><code><span>| </span></code><code><span>`HTTP <span class="keyword">of</span> <span class="xref-unresolved">Httpaf</span>.Response.t * <span class="xref-unresolved">Piaf</span>.Body.t</span></code></td></tr></table><code><span> ]</span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-pull_error" class="anchored"><a href="#type-pull_error" class="anchor"></a><code><span><span class="keyword">type</span> pull_error</span><span> = </span><span>[ </span></code><table><tr id="type-pull_error.Empty" class="anchored"><td class="def constructor"><a href="#type-pull_error.Empty" class="anchor"></a><code><span>| </span></code><code><span>`Empty</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>The incoming message stream is empty.</p><span class="comment-delim">*)</span></td></tr><tr id="type-pull_error.Timeout" class="anchored"><td class="def constructor"><a href="#type-pull_error.Timeout" class="anchor"></a><code><span>| </span></code><code><span>`Timeout</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Could not get a message from the stream within the given timeout.</p><span class="comment-delim">*)</span></td></tr><tr id="type-pull_error.Connection_close" class="anchored"><td class="def constructor"><a href="#type-pull_error.Connection_close" class="anchor"></a><code><span>| </span></code><code><span>`Connection_close</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Connection was closed by the client. <b>Warning:</b> you must exit the WebSocket handler as soon as possible when this happens. Otherwise, you will be in an infinite loop waiting for messages that will never arrive.</p><span class="comment-delim">*)</span></td></tr></table><code><span> ]</span></code></div><div class="spec-doc"><p>Possible issues with pulling a message from the incoming messages stream.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-pull" class="anchored"><a href="#type-pull" class="anchor"></a><code><span><span class="keyword">type</span> pull</span><span> = <span>float <span class="arrow">&#45;&gt;</span></span> <span><span>(string, <a href="#type-pull_error">pull_error</a>)</span> <span class="xref-unresolved">Lwt_result</span>.t</span></span></code></div><div class="spec-doc"><p><code>pull(timeout_s)</code> asynchronously gets the next message from the WebSocket if there is any, with a timeout in seconds of <code>timeout_s</code>. If it doesn't time out it returns <code>Some string</code>, otherwise <code>None</code>.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-push" class="anchored"><a href="#type-push" class="anchor"></a><code><span><span class="keyword">type</span> push</span><span> = <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>push(response)</code> pushes the string <code>response</code> to the WebSocket client.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-handler" class="anchored"><a href="#type-handler" class="anchor"></a><code><span><span class="keyword">type</span> handler</span><span> = <span><a href="#type-pull">pull</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-push">push</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>handler(pull, push)</code> is an asynchronous callback that manages the WS from the server side. The WS will shut down from the server side as soon as <code>handler</code> exits, so if you want to keep it open you need to make it call itself recursively. Because the call will be tail-recursive, OCaml's tail-call elimination takes care of stack memory use.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-websocket" class="anchored"><a href="#type-websocket" class="anchor"></a><code><span><span class="keyword">type</span> websocket</span><span> = </span><span>[ </span></code><table><tr id="type-websocket.WebSocket" class="anchored"><td class="def constructor"><a href="#type-websocket.WebSocket" class="anchor"></a><code><span>| </span></code><code><span>`WebSocket <span class="keyword">of</span> <span><span class="xref-unresolved">Httpaf</span>.Headers.t option</span> * <a href="#type-handler">handler</a></span></code></td></tr></table><code><span> ]</span></code></div><div class="spec-doc"><p>A WebSocket response.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>'resp t</span></span><span> = <span>[&gt; <a href="#type-http">http</a> <span>| <a href="#type-websocket">websocket</a></span> ]</span> <span class="keyword">as</span> 'resp</span></code></div><div class="spec-doc"><p>Response type, can be an HTTP or a WebSocket response. Many of the functions below work with either HTTP or WebSocket responses, and some with only one or the other. This is enforced at the type level.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-add_cookie" class="anchored"><a href="#val-add_cookie" class="anchor"></a><code><span><span class="keyword">val</span> add_cookie : <span><a href="../../ReWeb__Header/SetCookie/index.html#type-t">ReWeb__Header__SetCookie.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>[&lt; <a href="#type-http">http</a> <span>| <a href="#type-websocket">websocket</a></span> ]</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">_</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>add_cookie(cookie, response)</code> returns a response with a cookie <code>cookie</code> added to the original <code>response</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-add_cookies" class="anchored"><a href="#val-add_cookies" class="anchor"></a><code><span><span class="keyword">val</span> add_cookies : <span><span><a href="../../ReWeb__Header/SetCookie/index.html#type-t">ReWeb__Header__SetCookie.t</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span>[&lt; <a href="#type-http">http</a> <span>| <a href="#type-websocket">websocket</a></span> ]</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">_</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>add_cookies(cookies, response)</code> returns a response with the <code>cookies</code> added to the original <code>response</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-add_header" class="anchored"><a href="#val-add_header" class="anchor"></a><code><span><span class="keyword">val</span> add_header : <span>?replace:bool <span class="arrow">&#45;&gt;</span></span> <span>name:string <span class="arrow">&#45;&gt;</span></span> <span>value:string <span class="arrow">&#45;&gt;</span></span> <span><span>[&lt; <a href="#type-http">http</a> <span>| <a href="#type-websocket">websocket</a></span> ]</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">_</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>add_header(?replace, ~name, ~value, response)</code> returns a response with a header <code>name</code> with value <code>value</code> added to the original <code>response</code>. If the response already contains the <code>header</code>, then it is replaced only if <code>replace</code> is <code>true</code>, which is the default.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-add_headers" class="anchored"><a href="#val-add_headers" class="anchor"></a><code><span><span class="keyword">val</span> add_headers : <span><a href="#type-headers">headers</a> <span class="arrow">&#45;&gt;</span></span> <span><span>[&lt; <a href="#type-http">http</a> <span>| <a href="#type-websocket">websocket</a></span> ]</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">_</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>add_headers(headers, response)</code> returns a response with the <code>headers</code> added to the end of the original <code>response</code>'s header list.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-add_headers_multi" class="anchored"><a href="#val-add_headers_multi" class="anchor"></a><code><span><span class="keyword">val</span> add_headers_multi : <span><span><span>(string * <span>string list</span>)</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span>[&lt; <a href="#type-http">http</a> <span>| <a href="#type-websocket">websocket</a></span> ]</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">_</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>add_headers_multi(headers_multi, response)</code> returns a response with <code>headers_multi</code> added to the end of the original <code>response</code>'s header list.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-body" class="anchored"><a href="#val-body" class="anchor"></a><code><span><span class="keyword">val</span> body : <span><span>[&lt; <a href="#type-http">http</a> ]</span> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Piaf</span>.Body.t</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-cookies" class="anchored"><a href="#val-cookies" class="anchor"></a><code><span><span class="keyword">val</span> cookies : <span><span>[&lt; <a href="#type-http">http</a> <span>| <a href="#type-websocket">websocket</a></span> ]</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../ReWeb__Header/SetCookie/index.html#type-t">ReWeb__Header__SetCookie.t</a> list</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-header" class="anchored"><a href="#val-header" class="anchor"></a><code><span><span class="keyword">val</span> header : <span>string <span class="arrow">&#45;&gt;</span></span> <span><span>[&lt; <a href="#type-http">http</a> <span>| <a href="#type-websocket">websocket</a></span> ]</span> <span class="arrow">&#45;&gt;</span></span> <span>string option</span></span></code></div><div class="spec-doc"><p><code>header(name, request)</code> gets the last value corresponding to the given header, if present.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-headers" class="anchored"><a href="#val-headers" class="anchor"></a><code><span><span class="keyword">val</span> headers : <span>string <span class="arrow">&#45;&gt;</span></span> <span><span>[&lt; <a href="#type-http">http</a> <span>| <a href="#type-websocket">websocket</a></span> ]</span> <span class="arrow">&#45;&gt;</span></span> <span>string list</span></span></code></div><div class="spec-doc"><p><code>headers(name, request)</code> gets all the values corresponding to the given header.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-of_binary" class="anchored"><a href="#val-of_binary" class="anchor"></a><code><span><span class="keyword">val</span> of_binary : <span>?status:<a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> <span>?content_type:string <span class="arrow">&#45;&gt;</span></span> <span>?headers:<a href="#type-headers">headers</a> <span class="arrow">&#45;&gt;</span></span> <span>?cookies:<span><a href="../../ReWeb__Header/SetCookie/index.html#type-t">ReWeb__Header__SetCookie.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
<span>string <span class="arrow">&#45;&gt;</span></span> <span>[&gt; <a href="#type-http">http</a> ]</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-of_file" class="anchored"><a href="#val-of_file" class="anchor"></a><code><span><span class="keyword">val</span> of_file : <span>?status:<a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> <span>?content_type:string <span class="arrow">&#45;&gt;</span></span> <span>?headers:<a href="#type-headers">headers</a> <span class="arrow">&#45;&gt;</span></span> <span>?cookies:<span><a href="../../ReWeb__Header/SetCookie/index.html#type-t">ReWeb__Header__SetCookie.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
<span>string <span class="arrow">&#45;&gt;</span></span> <span><span>[&gt; <a href="#type-http">http</a> ]</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>of_file(?status, ?content_type, ?headers, ?cookies, file_name)</code> responds with the contents of <code>file_name</code>, which is a relative or absolute path, with HTTP response code <code>status</code> and content-type header <code>content_type</code>.</p><p>If the file is not found, responds with a 404 Not Found status and an appropriate message.</p><p><i>Warning</i> this function maps the entire file into memory. Don't use it for files larger than memory.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-of_html" class="anchored"><a href="#val-of_html" class="anchor"></a><code><span><span class="keyword">val</span> of_html : <span>?status:<a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> <span>?headers:<a href="#type-headers">headers</a> <span class="arrow">&#45;&gt;</span></span> <span>?cookies:<span><a href="../../ReWeb__Header/SetCookie/index.html#type-t">ReWeb__Header__SetCookie.t</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span>[&gt; <a href="#type-http">http</a> ]</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-of_http" class="anchored"><a href="#val-of_http" class="anchor"></a><code><span><span class="keyword">val</span> of_http : <span>status:<a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> <span>headers:<span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Piaf</span>.Body.t <span class="arrow">&#45;&gt;</span></span> <span>[&gt; <a href="#type-http">http</a> ]</span></span></code></div><div class="spec-doc"><p><code>of_http(~status, ~headers, body)</code> responds with an HTTP response composed of <code>status</code>, <code>headers</code>, and <code>body</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-of_json" class="anchored"><a href="#val-of_json" class="anchor"></a><code><span><span class="keyword">val</span> of_json : <span>?status:<a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> <span>?headers:<a href="#type-headers">headers</a> <span class="arrow">&#45;&gt;</span></span> <span>?cookies:<span><a href="../../ReWeb__Header/SetCookie/index.html#type-t">ReWeb__Header__SetCookie.t</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Yojson</span>.Safe.t <span class="arrow">&#45;&gt;</span></span> <span>[&gt; <a href="#type-http">http</a> ]</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-of_redirect" class="anchored"><a href="#val-of_redirect" class="anchor"></a><code><span><span class="keyword">val</span> of_redirect : <span>?content_type:string <span class="arrow">&#45;&gt;</span></span> <span>?body:string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span>[&gt; <a href="#type-http">http</a> ]</span></span></code></div><div class="spec-doc"><p><code>of_redirect(?content_type, ?body, location)</code> responds with an HTTP redirect response to the new <code>location</code>, with an optional <code>content_type</code> (defaulting to <code>text/plain</code>) and <code>body</code> (defaulting to an empty body).</p></div></div><div class="odoc-spec"><div class="spec value" id="val-of_status" class="anchored"><a href="#val-of_status" class="anchor"></a><code><span><span class="keyword">val</span> of_status : <span>?content_type:<span>[ `text <span>| `html</span> ]</span> <span class="arrow">&#45;&gt;</span></span> <span>?headers:<a href="#type-headers">headers</a> <span class="arrow">&#45;&gt;</span></span> <span>?cookies:<span><a href="../../ReWeb__Header/SetCookie/index.html#type-t">ReWeb__Header__SetCookie.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
<span>?message:string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> <span>[&gt; <a href="#type-http">http</a> ]</span></span></code></div><div class="spec-doc"><p><code>of_status(?content_type, ?headers, ?cookies, ?message, status)</code> responds with a standard boilerplate response message based on the <code>content_type</code> and <code>status</code>. <code>content_type</code> defaults to <code>`text</code>. The boilerplate message can be overridden by <code>message</code> if present.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-of_text" class="anchored"><a href="#val-of_text" class="anchor"></a><code><span><span class="keyword">val</span> of_text : <span>?status:<a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> <span>?headers:<a href="#type-headers">headers</a> <span class="arrow">&#45;&gt;</span></span> <span>?cookies:<span><a href="../../ReWeb__Header/SetCookie/index.html#type-t">ReWeb__Header__SetCookie.t</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span>[&gt; <a href="#type-http">http</a> ]</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-of_view" class="anchored"><a href="#val-of_view" class="anchor"></a><code><span><span class="keyword">val</span> of_view : <span>?status:<a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span> <span>?content_type:string <span class="arrow">&#45;&gt;</span></span> <span>?headers:<a href="#type-headers">headers</a> <span class="arrow">&#45;&gt;</span></span> <span>?cookies:<span><a href="../../ReWeb__Header/SetCookie/index.html#type-t">ReWeb__Header__SetCookie.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
<span><span>(<span><span>(<span>string <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> <span>[&gt; <a href="#type-http">http</a> ]</span></span></code></div><div class="spec-doc"><p><code>of_view(?status, ?content_type, ?headers, ?cookies, view)</code> responds with a rendered body as per the <code>view</code> function. The <code>view</code> is a function that takes a 'printer' function (<code>string -&gt; unit</code>) as a parameter and 'prints' (i.e. renders piecemeal) strings to it. These strings are pushed out as they are rendered.</p><p>The difference from <code>of_html</code>, <code>of_binary</code>, and the other functions is that those hold the entire response in memory before sending it to the client, while <code>of_view</code> holds only each piece of the response as it is streamed out.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-of_websocket" class="anchored"><a href="#val-of_websocket" class="anchor"></a><code><span><span class="keyword">val</span> of_websocket : <span>?headers:<a href="#type-headers">headers</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-handler">handler</a> <span class="arrow">&#45;&gt;</span></span> <span>[&gt; <a href="#type-websocket">websocket</a> ]</span></span></code></div><div class="spec-doc"><p><code>of_websocket(?headers, handler)</code> is an open WebSocket response. Optionally you can pass along extra <code>headers</code> which will be sent to the client when opening the WS.</p><p><i>Warning</i> it can be a little tricky to write a completely asynchronous WebSocket handler correctly. Be sure to read the reference documentation above, and the manual, carefully.</p><p><i>Note</i> OCaml strings are un-encoded byte arrays, and ReWeb treats all incoming and outgoing WebSocket data as such--even if the client is sending UTF-8 encoded text format (see <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API/Writing_WebSocket_servers#Format">https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API/Writing_WebSocket_servers#Format</a>). It's up to you as the WebSocket handler writer to encode/decode them as necessary.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-status" class="anchored"><a href="#val-status" class="anchor"></a><code><span><span class="keyword">val</span> status : <span><span>[&lt; <a href="#type-http">http</a> ]</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-status">status</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-status_code" class="anchored"><a href="#val-status_code" class="anchor"></a><code><span><span class="keyword">val</span> status_code : <span><span>[&lt; <a href="#type-http">http</a> ]</span> <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div></div></body></html>