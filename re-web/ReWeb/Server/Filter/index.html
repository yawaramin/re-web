<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Filter (re-web.ReWeb.Server.Filter)</title><link rel="stylesheet" href="../../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.0.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../../index.html">re-web</a> &#x00BB; <a href="../../index.html">ReWeb</a> &#x00BB; <a href="../index.html">Server</a> &#x00BB; Filter</nav><header class="odoc-preamble"><h1>Module <code><span>Server.Filter</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec module" id="module-Config" class="anchored"><a href="#module-Config" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Config/index.html">Config</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Service" class="anchored"><a href="#module-Service" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Service/index.html">Service</a></span><span> : <a href="../Service/module-type-S/index.html">Service.S</a> <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="../Service/module-type-S/Request/Reqd/index.html#type-t">Request.Reqd.t</a> = <span class="xref-unresolved">Httpaf</span>.Reqd.t</span> <span class="keyword">with</span> <span><span class="keyword">type</span> <span>'ctx <a href="../Service/module-type-S/Request/index.html#type-t">Request.t</a></span> = <span><span class="type-var">'ctx</span> <a href="../Request/index.html#type-t">Request.t</a></span></span> <span class="keyword">with</span> <span><span class="keyword">type</span>
<span>('ctx, 'resp) <a href="../Service/module-type-S/index.html#type-t">t</a></span> = <span><span>(<span class="type-var">'ctx</span>, <span class="type-var">'resp</span>)</span> <a href="../Service/index.html#type-t">Service.t</a></span></span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>('ctx1, 'ctx2, 'resp) t</span></span><span> = <span><span><span>(<span class="type-var">'ctx2</span>, <span class="type-var">'resp</span>)</span> <a href="Service/index.html#type-t">Service.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'ctx1</span>, <span class="type-var">'resp</span>)</span> <a href="Service/index.html#type-t">Service.t</a></span></span></code></div><div class="spec-doc"><p>A filter transforms a service. It can change the request (usually by changing the request context) or the response (by actually running the service and then modifying its response).</p><p>Filters can be composed using function composition.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-basic_auth" class="anchored"><a href="#val-basic_auth" class="anchor"></a><code><span><span class="keyword">val</span> basic_auth : <span><span>(<span class="type-var">'ctx1</span>, <span>&lt; username : string; password : string; prev : <span class="type-var">'ctx1</span>; &gt;</span>, <span><span class="type-var">_</span> <a href="../../Response/index.html#type-t">Response.t</a></span>)</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>basic_auth</code> decodes and stores the login credentials sent with the <code>Authorization</code> header or returns a 401 Unauthorized error if there is none.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-bearer_auth" class="anchored"><a href="#val-bearer_auth" class="anchor"></a><code><span><span class="keyword">val</span> bearer_auth : <span><span>(<span class="type-var">'ctx1</span>, <span>&lt; bearer_token : string; prev : <span class="type-var">'ctx1</span>; &gt;</span>, <span><span class="type-var">_</span> <a href="../../Response/index.html#type-t">Response.t</a></span>)</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>bearer_auth</code> stores the bearer token sent with the <code>Authorization</code> header or returns a 401 Unauthorized error if there is none.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-body_form" class="anchored"><a href="#val-body_form" class="anchor"></a><code><span><span class="keyword">val</span> body_form : <span><span><span>(<span class="type-var">'ctor</span>, <span class="type-var">'ty</span>)</span> <a href="../../Form/index.html#type-t">Form.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(unit, <span class="type-var">'ty</span>, <span>[&gt; <a href="../../Response/index.html#type-http">Response.http</a> ]</span>)</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>body_form(typ)</code> is a filter that decodes a web form in the request body and puts it inside the request for the next service. The decoding is done as specified by the form definition <code>typ</code>. If the form fails to decode, it short-circuits and returns a 400 Bad Request.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-body_json" class="anchored"><a href="#val-body_json" class="anchor"></a><code><span><span class="keyword">val</span> body_json : <span><span>(unit, <span class="xref-unresolved">Yojson</span>.Safe.t, <span>[&gt; <a href="../../Response/index.html#type-http">Response.http</a> ]</span>)</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>body_json</code> is a filter that transforms a 'root' service (i.e. one with <code>unit</code> context) into a service with a context containing the request body. If the request body fails to parse as valid JSON, it short-circuits and returns a 400 Bad Request.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-body_json_decode" class="anchored"><a href="#val-body_json_decode" class="anchor"></a><code><span><span class="keyword">val</span> body_json_decode : <span><span>(<span><span class="xref-unresolved">Yojson</span>.Safe.t <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'ty</span>, string)</span> <span class="xref-unresolved">Stdlib</span>.result</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="xref-unresolved">Yojson</span>.Safe.t, <span class="type-var">'ty</span>, <span>[&gt; <a href="../../Response/index.html#type-http">Response.http</a> ]</span>)</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>body_json_decode(decoder)</code> is a filter that transforms a service with a parsed JSON structure in its context, to a service with a decoded value of type <code>'ty</code> in its context. If the request body fails to decode with <code>decoder</code>, the filter short-circuits and returns a 400 Bad Request.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-body_string" class="anchored"><a href="#val-body_string" class="anchor"></a><code><span><span class="keyword">val</span> body_string : <span><span>(unit, string, <span>[&gt; <a href="../../Response/index.html#type-http">Response.http</a> ]</span>)</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>body_string</code> is a filter that transforms a 'root' service into a service whose context contains the request body as a single string.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-cache_control" class="anchored"><a href="#val-cache_control" class="anchor"></a><code><span><span class="keyword">val</span> cache_control : <span><a href="../../../ReWeb__Header/CacheControl/index.html#type-t">ReWeb__Header__CacheControl.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'ctx</span>, <span class="type-var">'ctx</span>, <span>[ <a href="../../Response/index.html#type-http">Response.http</a> <span>| <a href="../../Response/index.html#type-websocket">Response.websocket</a></span> ]</span>)</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>cache_control(policy)</code> is a filter that applies the caching <code>policy</code> policy to the HTTP response.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-cors" class="anchored"><a href="#val-cors" class="anchor"></a><code><span><span class="keyword">val</span> cors : <span><a href="../../../ReWeb__Header/AccessControlAllowOrigin/index.html#type-t">ReWeb__Header__AccessControlAllowOrigin.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'ctx</span>, <span class="type-var">'ctx</span>, <span>[ <a href="../../Response/index.html#type-http">Response.http</a> <span>| <a href="../../Response/index.html#type-websocket">Response.websocket</a></span> ]</span>)</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>cors(origin)</code> adds an <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Origin">Access-Control-Allow-Origin</a> header with the given <code>origin</code>.</p><p><i>Note</i> that it's upto you to pass in a well-formed origin string. The <code>Header.AccessControlAllowOrigin</code> module does not validate the origin string.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-csp" class="anchored"><a href="#val-csp" class="anchor"></a><code><span><span class="keyword">val</span> csp : <span><a href="../../../ReWeb__Header/ContentSecurityPolicy/index.html#type-t">ReWeb__Header__ContentSecurityPolicy.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'ctx</span>, <span class="type-var">'ctx</span>, <span>[ <a href="../../Response/index.html#type-http">Response.http</a> <span>| <a href="../../Response/index.html#type-websocket">Response.websocket</a></span> ]</span>)</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>csp(directives)</code> is a filter that applies the <code>Content-Security-Policy</code> header <code>directives</code> to the response.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-hsts" class="anchored"><a href="#val-hsts" class="anchor"></a><code><span><span class="keyword">val</span> hsts : <span><a href="../../../ReWeb__Header/StrictTransportSecurity/index.html#type-t">ReWeb__Header__StrictTransportSecurity.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'ctx</span>, <span class="type-var">'ctx</span>, <span>[ <a href="../../Response/index.html#type-http">Response.http</a> <span>| <a href="../../Response/index.html#type-websocket">Response.websocket</a></span> ]</span>)</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>hsts(value)</code> is a filter that applies the HTTP Strict Transport Security header to the response.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-multipart_form" class="anchored"><a href="#val-multipart_form" class="anchor"></a><code><span><span class="keyword">val</span> multipart_form : <span>typ:<span><span>(<span class="type-var">'ctor</span>, <span class="type-var">'ty</span>)</span> <a href="../../Form/index.html#type-t">Form.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>filename:string <span class="arrow">&#45;&gt;</span></span>
<span>string <span class="arrow">&#45;&gt;</span></span> string)</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(unit, <span class="type-var">'ty</span>, <span>[&gt; <a href="../../Response/index.html#type-http">Response.http</a> ]</span>)</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>multipart_form(~typ, path)</code> is a filter that decodes multipart form data. <code>typ</code> must be provided but if you don't actually have any other fields in the form you can use <code>Form.empty</code> to decode into an 'empty' (unit) value.</p><p><code>path(~filename, name)</code> is used to get the filesystem absolute path to save the given <code>filename</code> with corresponding form field <code>name</code>. Note that:</p><ul><li>The file will be overwritten if it already exists on disk</li><li><code>filename</code> is the basename, not the full path</li><li>The filter will short-circuit with a 401 Unauthorized error response if any of the files can't be opened for writing.</li></ul><p>This callback gives you a chance to sanitize incoming filenames before storing the files on disk.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-query_form" class="anchored"><a href="#val-query_form" class="anchor"></a><code><span><span class="keyword">val</span> query_form : <span><span><span>(<span class="type-var">'ctor</span>, <span class="type-var">'ty</span>)</span> <a href="../../Form/index.html#type-t">Form.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'ctx</span>, <span>&lt; query : <span class="type-var">'ty</span>; prev : <span class="type-var">'ctx</span>; &gt;</span>, <span><span class="type-var">_</span> <a href="../../Response/index.html#type-t">Response.t</a></span>)</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>query_form(typ)</code> is a filter that decodes the request query (the part after the <code>?</code> in the endpoint) into a value of type <code>'ty</code> and stores it in the request context for the next service. The decoding and failure works in the same way as for <code>body_form</code>.</p></div></div></div></body></html>